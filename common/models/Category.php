<?php

namespace common\models;

use Yii;
use \common\models\base\Category as BaseCategory;
use yii\helpers\ArrayHelper;
use yii\helpers\Url;

/**
 * This is the model class for table "category".
 */
class Category extends BaseCategory
{

    public function behaviors()
    {
        return ArrayHelper::merge(
            parent::behaviors(),
            [
                [
                    'class' => \nsept\behaviors\CyrillicSlugBehavior::className(),
                    'attribute' => 'name',
                    'slugAttribute' => 'alias'
                ],
            ]
        );
    }

    public function rules()
    {
        return [
            [['aksses_ids'], 'safe'],
            [['name', 'type'], 'required'],
            [['type', 'sort_order', 'parent_id', 'priority', 'disallow_xml'], 'integer'],
            [['text_advice', 'descr', 'seo_description'], 'string'],
            [['name', 'alias', 'image_catalog', 'image_menu', 'video', 'seo_h1', 'seo_title', 'seo_keywords'], 'string', 'max' => 255],
            ['parent_id', 'compare', 'compareValue' => 0, 'operator' => '!=', 'type' => 'number', 'when' => function ($model) {
                $result = false;
                $val = $model->type;

                if ($val == 1 || $val == 2 || $val == 3 || $val == 4) {
                    $result = true;
                }

                return $result;
            }, 'whenClient' => "function (attribute, value) {
                    var result = false;
                    var val = $('#category-parent_id').val();
                    
                    if (val == 1 || val == 2 || val == 3 || val == 4) {
                        result = true;
                    }
                    
                    return result;
                }"],
        ];
    }

    public function beforeValidate()
    {
        /*if (!empty($this->features)) {
            $this->features = json_encode($this->features);
        }*/

        if (!empty($this->aksses_ids)) {
            $this->aksses_ids = json_encode($this->aksses_ids);
        }

        return parent::beforeValidate(); // TODO: Change the autogenerated stub
    }

    public static function getCategoryChain($model = NULL) {
        $parents = ['0' => 'Нет родителя'];

        foreach(Category::find()
            ->where(['type' => 0])//категория
            ->orderBy(['name' => SORT_ASC])
            ->all() as $item) {
            if ($model == NULL || $model->id != $item->id) {
                $parents[$item->id] = $item->chain;
            }
        }

        return $parents;
    }

    public function getChain() {
        $item = $this;
        $name = $item->name;

        while($item->parent_id != 0) {
            $item = Category::findOne($item->parent_id);
            $name = "{$item->name} -> $name";
        }

        return $name;
    }
    
    public static function getList() {
        $result = [];

        foreach(Yii::$app->params['categoryTypes'] as $type => $typeName) {
            $categories = Category::find()
                ->where(['type' => $type])
                ->orderBy(['name' => SORT_ASC])
                ->all();

            foreach($categories as $category) {
                $result[$typeName][$category->id] = $category->chain;
            }
        }

        return $result;
    }

    public function getFeatures() {
        return Feature::find()
            ->where(['category_id' => $this->id])
            ->orderBy(['sort_order' => SORT_ASC, 'id' => SORT_ASC])
            ->all();
    }

    public function getInnerIds() {
        $ids = [];
        $innerCategories = $this->getInnerCategories();

        foreach($innerCategories as $ccc) {
            $ids[] = $ccc->id;
        }

        return $ids;
    }

    public function getInnerCategories() {
        $categories = [];
        $level = $this->getLevel();

        if ($level) {
            if ($level == 3) {
                $categories[] = $this;
            } else if ($level == 2) {
                $categories[] = $this;
                $cats = Category::findAll(['parent_id' => $this->id]);

                foreach($cats as $cat) {
                    $categories[] = $cat;
                }
            } else if ($level == 1) {
                $categories[] = $this;
                $cats = Category::findAll(['parent_id' => $this->id]);

                foreach($cats as $cat) {
                    $categories[] = $cat;

                    foreach(Category::findAll(['parent_id' => $cat->id]) as $item) {
                        $categories[] = $item;
                    }
                }
            } else {
                return false;
            }
        } else {
            return false;
        }

        return $categories;
    }
    
    public function getLevel() {
        if ($this->type != 0) {
            return false;//Не Категория
        }


        if ($this->parent_id == 0) {
            return 1;
        } else {
            $cat = Category::find()->where(['id' => $this->parent_id, 'type' => 0])->one();

            if ($cat->parent_id == 0) {
                return 2;
            } else {
                $cat = Category::find()->where(['id' => $cat->parent_id, 'type' => 0])->one();

                if ($cat->parent_id == 0) {
                    return 3;
                }
            }

            return false;
        }
    }
    public function getBreadcrumbs() {
        $items = ['/catalog' => 'Каталог'];
        $level = $this->getLevel();

        if ($level) {
            if ($level == 3) {
                //////////////////////////////////////////////
                $cat = Category::findOne(['id' => $this->parent_id]);
                $cat2 = Category::findOne(['id' => $cat->parent_id]);
                $cat2Url = Url::to(['catalog/index', 'alias' => $cat2->alias]);
                $catUrl = Url::to(['catalog/index', 'alias' => $cat2->alias, 'alias2' => $cat->alias]);
                $items[$cat2Url] = $cat2->name;
                $items[$catUrl] = $cat->name;
                //////////////////////////////////////////////
                $items[0] = $this->name;
            } else if ($level == 2) {
                //////////////////////////////////////////////
                $cat = Category::findOne(['id' => $this->parent_id]);
                $catUrl = Url::to(['catalog/index', 'alias' => $cat->alias]);
                $items[$catUrl] = $cat->name;
                //////////////////////////////////////////////
                $items[0] = $this->name;
            } else if ($level == 1) {
                $items[0] = $this->name;
            } else {
                return false;
            }
        } else {
            return false;
        }

        return $items;
    }
}
